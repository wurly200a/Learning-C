name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y libcmocka-dev cmake lcov

    - name: Build tests and Test
      run: |
        for dir in $(find tests/ -type d); do
          if [ -f "$dir/Makefile" ]; then
            make -C "$dir"
            make -C "$dir" test
          fi
        done

    - name: Build src
      run: |
        for dir in $(find src/ -type d); do
          if [ -f "$dir/Makefile" ]; then
            make -C "$dir"
          fi
        done

    - name: Generate Coverage Report
      run: |
        lcov --directory src --capture --output-file coverage.info
        genhtml coverage.info --output-directory coverage
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/
